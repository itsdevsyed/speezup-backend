datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

// -----------------------------------------------------------------------------
// Core Enums
// -----------------------------------------------------------------------------
enum UserRole {
  CUSTOMER
  STORE_OWNER
  DELIVERY_PARTNER
}

enum OrderStatus {
  PENDING
  ACCEPTED
  PROCESSING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

// -----------------------------------------------------------------------------
// User Models
// -----------------------------------------------------------------------------
model User {
  id              Int           @id @default(autoincrement())
  email           String?       @unique
  name            String?
  phone           String?       @unique
  role            UserRole      @default(CUSTOMER)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?

  // Relations
  addresses       Address[]     // A user can have multiple addresses
  orders          Order[]
  cartItems       CartItem[]
  stores          Store[]
  deliveryProfile Delivery?
  refreshTokens   RefreshToken[]
}

model Address {
  id          Int       @id @default(autoincrement())
  street      String
  city        String
  state       String
  postalCode  String
  country     String
  latitude    Float
  longitude   Float

  // Many-to-one
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int?

  // One-to-one (Store)
  store       Store?
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relation
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
}

// -----------------------------------------------------------------------------
// Store Models
// -----------------------------------------------------------------------------
model Store {
  id              Int             @id @default(autoincrement())
  name            String
  description     String?
  phone           String?
  status          String          @default("OPEN")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  deletedAt       DateTime?

  // Relations
  owner           User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId         Int

  addressId       Int             @unique
  address         Address         @relation(fields: [addressId], references: [id], onDelete: Cascade)

  storeCategories StoreCategory[] @relation("StoreCategoriesOnStores")
  products        Product[]
  orders          Order[]
}

model StoreCategory {
  id      Int     @id @default(autoincrement())
  name    String  @unique

  stores  Store[] @relation("StoreCategoriesOnStores")
}

// -----------------------------------------------------------------------------
// Product & Category
// -----------------------------------------------------------------------------
model Product {
  id          Int        @id @default(autoincrement())
  name        String
  description String?
  imageUrl    String?
  price       Decimal     @db.Decimal(10, 2)
  stock       Int
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?

  store       Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeId     Int

  category    Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId  Int

  cartItems   CartItem[]
  orderItems  OrderItem[]
}

model Category {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  products    Product[]
}

// -----------------------------------------------------------------------------
// Delivery Models
// -----------------------------------------------------------------------------
model Delivery {
  id                       Int      @id @default(autoincrement())
  currentLocationLatitude  Float?
  currentLocationLongitude Float?
  status                   String   @default("AVAILABLE")
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  // One-to-one with User
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                   Int      @unique

  assignedOrders           Order[]
}

// -----------------------------------------------------------------------------
// Orders & Cart
// -----------------------------------------------------------------------------
model Order {
  id                Int          @id @default(autoincrement())
  totalPrice        Decimal      @db.Decimal(10, 2)
  status            OrderStatus  @default(PENDING)
  createdAt         DateTime     @default(now())
  acceptedAt        DateTime?
  deliveredAt       DateTime?

  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            Int

  store             Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeId           Int

  deliveryPartner   Delivery?    @relation(fields: [deliveryPartnerId], references: [id], onDelete: SetNull)
  deliveryPartnerId Int?

  items             OrderItem[]
}

model OrderItem {
  id         Int       @id @default(autoincrement())
  quantity   Int
  price      Decimal    @db.Decimal(10, 2)

  order      Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId    Int

  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId  Int
}

model CartItem {
  id        Int      @id @default(autoincrement())
  quantity  Int

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int

  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId Int

  @@unique([userId, productId])
}
